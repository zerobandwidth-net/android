<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionCheckpoint.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">net.zer0bandwidth.android.lib.security</a> &gt; <span class="el_source">PermissionCheckpoint.java</span></div><h1>PermissionCheckpoint.java</h1><pre class="source lang-java linenums">package net.zer0bandwidth.android.lib.security;

import android.app.Activity;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Build;
import android.provider.Settings;
import android.support.annotation.NonNull;
import android.support.annotation.RequiresApi;
import android.support.v4.app.ActivityCompat;
import android.support.v4.content.ContextCompat;
import android.support.v7.app.AppCompatActivity;
import android.util.Log;

import net.zer0bandwidth.android.lib.R;

import java.util.ArrayList;
import java.util.HashMap;

/**
 * This class checks a specified list of &quot;dangerous&quot; permissions, forcing the
 * user to grant each one at runtime.
 *
 * &lt;h3&gt;Using this Class&lt;/h3&gt;
 *
 * &lt;h4&gt;Defining the List of Permissions&lt;/h4&gt;
 *
 * &lt;p&gt;By default, the list of dangerous permissions is drawn from the string
 * array resource named by {@link R.array#asDangerousPermissionsRequired} in
 * this library. By default, the array is empty; the app consuming this library
 * may override the resource with its own values.&lt;/p&gt;
 *
 * &lt;p&gt;The consumer of this class may, alternatively, supply a different resource
 * ID to one of the longer constructors. This will &lt;i&gt;replace&lt;/i&gt; the default
 * array resource as the definitive list of required permissions.&lt;/p&gt;
 *
 * &lt;h4&gt;Maintain a Persistent Instance in the Activity&lt;/h4&gt;
 *
 * &lt;p&gt;The main activity of the app should construct an instance of this class in
 * its {@code onCreate} method, using itself as the operational context, and
 * optionally specifying an alternative list of permissions.&lt;/p&gt;
 *
 * &lt;pre&gt;
 *     protected PermissionCheckpoint m_perms = null ;
 *
 *    {@literal @Override}
 *     protected void onCreate( Bundle bndlState )
 *     {
 *         super.onCreate(bndlState) ;
 *         this.setContentView( R.layout.whatever ) ;
 *         if( Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M )
 *             m_perms = new PermissionCheckpoint(this) ;
 *         // ...
 *     }
 * &lt;/pre&gt;
 *
 * &lt;h4&gt;Refresh Permission State on Each {@code onResume}&lt;/h4&gt;
 *
 * &lt;p&gt;The activity's {@code onResume} method must include a call to this class's
 * {@link #performChecks()} method, which re-evaluates the app's permissions
 * each time it is invoked.&lt;/p&gt;
 *
 * &lt;pre&gt;
 *    {@literal @Override}
 *     protected void onResume()
 *     {
 *         super.onResume() ;
 *         if( m_perms != null ) m_perms.performChecks() ;
 *     }
 * &lt;/pre&gt;
 *
 * &lt;h4&gt;Implement the Permission Request Callback&lt;/h4&gt;
 *
 * &lt;p&gt;Finally, the activity must provide a callback for the Android OS in
 * response to a permission request.&lt;/p&gt;
 *
 * &lt;h5&gt;{@link Activity}&lt;/h5&gt;
 *
 * &lt;p&gt;Modern activities include their own callback method, which must be
 * overridden in your activity.&lt;/p&gt;
 *
 * &lt;pre&gt;
 *     public class MyActivity extends Activity
 *     {
 *         protected PermissionCheckpoint m_perms = null ; // init in onCreate()
 *
 *         // etc
 *
 *        {@literal @RequiresApi( api = Build.VERSION_CODES.M )}
 *        {@literal @Override}
 *         public void onRequestPermissionsResult( int zRequestCode,
 *            {@literal @NonNull} String[] asPermissions,{@literal @NonNull} int[] azStatus )
 *         {
 *             super.onRequestPermissionsResult( zRequestCode, asPermissions, azStatus ) ;
 *             if( m_perms != null )
 *                 m_perms.processRequestResults( zRequestCode, asPermissions, azStatus ) ;
 *         }
 *     }
 * &lt;/pre&gt;
 *
 * &lt;h5&gt;{@link AppCompatActivity}&lt;/h5&gt;
 *
 * &lt;p&gt;An activity from the compatibility library should implement the
 * {@link ActivityCompat.OnRequestPermissionsResultCallback} interface.&lt;/p&gt;
 *
 * &lt;pre&gt;
 *     public class MyCompatActivity extends AppCompatActivity
 *     implements ActivityCompat.OnRequestPermissionsResultCallback
 *     {
 *         protected PermissionCheckpoint m_perms = null ; // init in onCreate()
 *
 *         // etc
 *
 *        {@literal @RequiresApi( api = Build.VERSION_CODES.M )}
 *        {@literal @Override}
 *         public void onRequestPermissionsResult( int zRequestCode,
 *            {@literal @NonNull} String[] asPermissions,{@literal @NonNull} int[] azStatus )
 *         {
 *             if( m_perms != null )
 *                 m_perms.processRequestResults( zRequestCode, asPermissions, azStatus ) ;
 *         }
 *     }
 * &lt;/pre&gt;
 *
 * &lt;h3&gt;Acknowledgements&lt;/h3&gt;
 *
 * Special thanks to {@code @dapayne1} for doing the heavy lifting on the
 * research for Android 6 permissions management, and providing the original
 * reference implementation from which this class was adapted.
 *
 * @since zer0bandwidth-net/android 0.0.3 (#10)
 */
@SuppressWarnings( &quot;unused&quot; )                              // This is a library.
public class PermissionCheckpoint
{
<span class="fc" id="L139">	public static final String LOG_TAG =</span>
<span class="fc" id="L140">			PermissionCheckpoint.class.getSimpleName() ;</span>

	/**
	 * An identifier used in permission requests.
	 */
	protected static final int DANGER_REQUEST_CODE = 4 ;

	protected static final String PERMISSION_WRITE_SETTINGS =
			&quot;android.permission.WRITE_SETTINGS&quot; ;

	/**
	 * Static method allowing any class to check the momentary status of a
	 * permission.
	 * @param ctx the context in which to perform the check
	 * @param sPermission the qualified name of the permission to check
	 * @return {@code true} iff the permission has been granted to the app
	 */
	public static boolean checkPermission( Context ctx, String sPermission )
	{
		boolean bGranted ;
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">		if( Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">		 &amp;&amp; PERMISSION_WRITE_SETTINGS.equals(sPermission) )</span>
		{
<span class="fc" id="L163">			bGranted = Settings.System.canWrite( ctx ) ;</span>
		}
		else
		{
<span class="fc" id="L167">			final int zStatus =</span>
<span class="fc" id="L168">					ContextCompat.checkSelfPermission( ctx, sPermission ) ;</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">			bGranted = ( zStatus == PackageManager.PERMISSION_GRANTED ) ;</span>
		}
<span class="fc" id="L171">		Log.d( LOG_TAG, (new StringBuilder())</span>
<span class="fc" id="L172">				.append( &quot;Permission [&quot; )</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">				.append( sPermission )</span>
<span class="fc" id="L174">				.append(( bGranted ? &quot;]   GRANTED&quot; : &quot;]   DENIED&quot; ))</span>
<span class="fc" id="L175">				.toString()</span>
			);
<span class="fc" id="L177">		return bGranted ;</span>
	}

	/**
	 * An {@link AppCompatActivity} which provides the context from which
	 * resources are resolved and additional dialogs and activities may be
	 * launched. Only one of {@code m_actCompatContext} and
	 * {@link #m_actContext} should be set for any given instance.
	 */
<span class="nc" id="L186">	protected AppCompatActivity m_actCompatContext = null ;</span>

	/**
	 * An {@link Activity} which provides the context from which resources
	 * are resolved and additional dialogs and activities may be launched.
	 * Only one of {@link #m_actCompatContext} and {@code m_actContext} should
	 * be set for any given instance.
	 */
<span class="nc" id="L194">	protected Activity m_actContext = null ;</span>

	/**
	 * Since both {@link Activity} and {@link AppCompatActivity} are
	 * descendants of {@link Context}, this field allows whichever one we end up
	 * with to represent the operational context of the instance, where we can
	 * use {@code Context} for resource resolution, etc.
	 */
<span class="nc" id="L202">	protected Context m_ctx = null ;</span>

	/**
	 * The default string array resource in which dangerous permissions are
	 * defined. Apps that use this library may choose to override this
	 * {@link R.array#asDangerousPermissionsRequired} resource, or have their
	 * own resource which is passed into the constructor.
	 */
<span class="fc" id="L210">	protected static final int DEFAULT_DANGER_LIST_RESOURCE =</span>
			R.array.asDangerousPermissionsRequired ;
	/**
	 * The resource ID of the string array that defines the list of dangerous
	 * permissions that should be requested. This defaults to the value of
	 * {@link #DEFAULT_DANGER_LIST_RESOURCE}, which is
	 * {@link R.array#asDangerousPermissionsRequired}.
	 */
<span class="nc" id="L218">	protected int m_resDangerList = DEFAULT_DANGER_LIST_RESOURCE ;</span>

	/**
	 * Tracks the list of &quot;dangerous&quot; permissions that need to be granted to the
	 * app, and the current status of each.
	 */
<span class="nc" id="L224">	protected HashMap&lt;String,Boolean&gt; m_mapGranted = null ;</span>

	/** Indicates that any permission dialog is currently being displayed. */
<span class="nc" id="L227">	protected boolean m_bDialogVisible = false ;</span>

	/** Indicates the &quot;build flavor&quot; used to build the app, if any. */
<span class="nc" id="L230">	protected String m_sFlavor = null ;</span>

	/**
	 * Initializes the instance with an {@link Activity} as the context.
	 * The default string array resource,
	 * {@link R.array#asDangerousPermissionsRequired}, will be used to define
	 * the list of dangerous permissions required by the app.
	 * @param act the activity which provides operational context
	 */
	public PermissionCheckpoint( Activity act )
<span class="nc" id="L240">	{ this( act, DEFAULT_DANGER_LIST_RESOURCE ) ; }</span>

	/**
	 * Initializes the instance with an {@link Activity} as the context.
	 * @param act the activity which provides operational context
	 * @param resDangerList the resource ID for the list of dangerous
	 *                      permissions required by the app
	 */
	public PermissionCheckpoint( Activity act, int resDangerList )
<span class="nc" id="L249">	{</span>
<span class="nc" id="L250">		m_actCompatContext = null ;</span>
<span class="nc" id="L251">		m_actContext = act ;</span>
<span class="nc" id="L252">		this.init( resDangerList ) ;</span>
<span class="nc" id="L253">	}</span>

	/**
	 * Initializes the instance with an {@link AppCompatActivity} as the context.
	 * The default string array resource,
	 * {@link R.array#asDangerousPermissionsRequired}, will be used to define
	 * the list of dangerous permissions required by the app.
	 * @param act the activity which provides operational context
	 */
	public PermissionCheckpoint( AppCompatActivity act )
<span class="nc" id="L263">	{ this( act, DEFAULT_DANGER_LIST_RESOURCE ) ; }</span>

	/**
	 * Initializes the instance with an {@link AppCompatActivity} as the context.
	 * @param act the activity which provides operational context
	 * @param resDangerList the resource ID for the list of dangerous
	 *                      permissions required by the app
	 */
	public PermissionCheckpoint( AppCompatActivity act, int resDangerList )
<span class="nc" id="L272">	{</span>
<span class="nc" id="L273">		m_actCompatContext = act ;</span>
<span class="nc" id="L274">		m_actContext = null ;</span>
<span class="nc" id="L275">		this.init( resDangerList ) ;</span>
<span class="nc" id="L276">	}</span>

	/**
	 * Initializes various fields within the instance, once context has been
	 * established.
	 * @param resDangerList the resource ID for the list of dangerous
	 *                      permissions required by the app
	 * @return (fluid)
	 */
	protected PermissionCheckpoint init( int resDangerList )
	{
<span class="nc" id="L287">		m_resDangerList = resDangerList ;</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">		m_ctx = ( this.isContextAppCompat() ? m_actCompatContext : m_actContext ) ;</span>
<span class="nc" id="L289">		String[] asDangers =</span>
<span class="nc" id="L290">				m_ctx.getResources().getStringArray( m_resDangerList ) ;</span>
<span class="nc" id="L291">		m_mapGranted = new HashMap&lt;&gt;( asDangers.length ) ;</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">		for( String sDanger : asDangers )</span>
		{ // Add the status of that permission to the object's map.
<span class="nc" id="L294">			m_mapGranted.put( sDanger, checkPermission( m_ctx, sDanger ) ) ;</span>
		}
<span class="nc" id="L296">		return this ;</span>
	}

	/**
	 * Indicates whether the instance's operational context is an
	 * {@link AppCompatActivity}.
	 * @return {@code true} if an {@code AppCompatActivity} was used as the
	 *  initial context for the instance
	 */
	protected boolean isContextAppCompat()
<span class="nc bnc" id="L306" title="All 4 branches missed.">	{ return ( m_actCompatContext != null &amp;&amp; m_actContext == null ) ; }</span>

	/**
	 * This method performs all the checks necessary to determine whether the
	 * app has all of its required permissions. If any permission is still
	 * denied, then the method will trigger dialogs challenging the user to
	 * grant those permissions to the app.
	 * @return (fluid)
	 */
	public PermissionCheckpoint performChecks()
	{
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if( Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.M )</span>
<span class="nc" id="L318">			return this ; // trivially</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">		if( ! this.hasGrantedAll() )</span>
<span class="nc" id="L321">			this.promptForPermissions() ;</span>

<span class="nc" id="L323">		return this ;</span>
	}

	/**
	 * Evaluates whether all required &quot;dangerous&quot; permissions have been granted.
	 *
	 * For most permissions, we have cached the state via
	 * {@link #processRequestResults}, but for the {@code WRITE_SETTINGS}
	 * permission, we have to explicitly re-check it, because there's no way to
	 * listen for a state-change event from the Android OS's application
	 * manager.
	 *
	 * @return {@code true} if all permissions are granted.
	 */
	protected boolean hasGrantedAll()
	{
//		this.logPermissionState() ;        // Comment out this line for release!
<span class="nc bnc" id="L340" title="All 2 branches missed.">		if( m_mapGranted.size() == 0 ) return true ; // No permissions to grant.</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">		if( m_mapGranted.containsKey( PERMISSION_WRITE_SETTINGS ) )</span>
		{ // Explicitly re-check whether we've been granted WRITE_SETTINGS.
<span class="nc" id="L343">			m_mapGranted.put( PERMISSION_WRITE_SETTINGS,</span>
<span class="nc" id="L344">					checkPermission( m_ctx, PERMISSION_WRITE_SETTINGS ) ) ;</span>
		}
<span class="nc bnc" id="L346" title="All 2 branches missed.">		return( ! m_mapGranted.containsValue(false) ) ;    // All marked &quot;true&quot;.</span>
	}

	/**
	 * (debug only) Dumps the current state of the permission map to the Android
	 * logs.
	 * @return (fluid)
	 * @see #hasGrantedAll()
	 */
	protected PermissionCheckpoint logPermissionState()
	{
<span class="nc" id="L357">		StringBuilder sb = new StringBuilder() ;</span>
<span class="nc" id="L358">		sb.append( &quot;DEBUG Current permission state:\n&quot; ) ;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">		for( HashMap.Entry&lt;String,Boolean&gt; pair : m_mapGranted.entrySet() )</span>
		{
<span class="nc" id="L361">			sb.append( &quot;\t\t&quot; )</span>
<span class="nc" id="L362">			  .append( pair.getKey() )</span>
<span class="nc" id="L363">			  .append( &quot;\t&quot; )</span>
<span class="nc" id="L364">			  .append( pair.getValue() )</span>
<span class="nc" id="L365">			  .append( &quot;\n&quot; )</span>
			  ;
<span class="nc" id="L367">		}</span>
<span class="nc" id="L368">		Log.d( LOG_TAG, sb.toString() ) ;</span>
<span class="nc" id="L369">		return this ;</span>
	}

	/**
	 * Prompts the user to accept all &quot;dangerous&quot; permission requests.
	 *
	 * The method tries to ask for just regularly-dangerous permissions first,
	 * then asks for the &quot;write settings&quot; permission if all others have been
	 * granted.
	 *
	 * @return (fluid)
	 */
	protected PermissionCheckpoint promptForPermissions()
	{
<span class="nc" id="L383">		ArrayList&lt;String&gt; asRequired = new ArrayList&lt;&gt;() ;</span>
<span class="nc" id="L384">		boolean bWriteSettings = false ;</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">		for( HashMap.Entry&lt;String,Boolean&gt; pair : m_mapGranted.entrySet() )</span>
		{
<span class="nc bnc" id="L387" title="All 2 branches missed.">			if( ! pair.getValue() )</span>
			{ // Found a permission that has not yet been granted.
<span class="nc bnc" id="L389" title="All 2 branches missed.">				if( pair.getKey().equals( PERMISSION_WRITE_SETTINGS ) )</span>
				{
<span class="nc" id="L391">					Log.w( LOG_TAG,</span>
							&quot;App needs special WRITE_SETTINGS permission.&quot; ) ;
<span class="nc" id="L393">					bWriteSettings = true;</span>
				}
				else
				{
<span class="nc" id="L397">					Log.w( LOG_TAG, (new StringBuilder())</span>
<span class="nc" id="L398">							.append( &quot;App needs &quot; )</span>
<span class="nc" id="L399">							.append( pair.getKey() )</span>
<span class="nc" id="L400">							.append( &quot; permission.&quot; )</span>
<span class="nc" id="L401">							.toString()</span>
						);
<span class="nc" id="L403">					asRequired.add( pair.getKey() );</span>
				}
			}
<span class="nc" id="L406">		}</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">		if( asRequired.size() &gt; 0 )</span>
<span class="nc" id="L408">			this.promptForOtherDangers( asRequired ) ;</span>
<span class="nc bnc" id="L409" title="All 4 branches missed.">		else if( bWriteSettings &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M )</span>
<span class="nc" id="L410">			this.promptForWriteSettingsPermission();</span>

<span class="nc" id="L412">		return this ;</span>
	}

	/**
	 * Prompts the user to enable the &quot;write settings&quot; permission, which can be
	 * administered only on a special Android OS dialog.
	 * @return (fluid)
	 */
	@RequiresApi( api = Build.VERSION_CODES.M )
	protected PermissionCheckpoint promptForWriteSettingsPermission()
	{
<span class="nc bnc" id="L423" title="All 2 branches missed.">		if( ! m_bDialogVisible )</span>
		{
<span class="nc" id="L425">			final WriteSettingsDialogClickListener listener =</span>
					new WriteSettingsDialogClickListener() ;
<span class="nc bnc" id="L427" title="All 2 branches missed.">			if( this.isContextAppCompat() )</span>
<span class="nc" id="L428">				this.promptWithAppCompatDialog( listener ) ;</span>
			else
<span class="nc" id="L430">				this.promptWithModernDialog( listener ) ;</span>
		}
<span class="nc" id="L432">		return this ;</span>
	}

	/**
	 * Defines a click listener for the dialog that prompts the user to grant
	 * the special {@code WRITE_SETTINGS} permission.
	 * @see PermissionCheckpoint#promptWithModernDialog
	 * @see PermissionCheckpoint#promptWithAppCompatDialog
	 * @since zer0bandwidth-net/android 0.0.3 (#10)
	 */
<span class="nc" id="L442">	protected class WriteSettingsDialogClickListener</span>
	implements DialogInterface.OnClickListener
	{
		/** An alert from the modern library. */
<span class="nc" id="L446">		public android.app.AlertDialog m_diaModernParent = null ;</span>

		/** An alert dialog from the compatibility library. */
<span class="nc" id="L449">		public android.support.v7.app.AlertDialog m_diaCompatParent = null ;</span>

		/** Sets the parent dialog from the modern library. */
		public WriteSettingsDialogClickListener setParent( android.app.AlertDialog dia )
<span class="nc" id="L453">		{ m_diaModernParent = dia ; m_diaCompatParent = null ; return this ; }</span>

		/** Sets the parent dialog from the compatibility library. */
		public WriteSettingsDialogClickListener setParent( android.support.v7.app.AlertDialog dia )
<span class="nc" id="L457">		{ m_diaModernParent = null ; m_diaCompatParent = dia ; return this ; }</span>

		@RequiresApi( api = Build.VERSION_CODES.M )
		@Override
		public void onClick( DialogInterface dia, int zButtonID )
		{
<span class="nc" id="L463">			Intent sig = new Intent( Settings.ACTION_MANAGE_WRITE_SETTINGS ) ;</span>
<span class="nc" id="L464">			sig.setData( Uri.parse( &quot;package:&quot; + m_ctx.getPackageName() ) ) ;</span>
<span class="nc" id="L465">			m_ctx.startActivity( sig ) ;</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			if( m_diaModernParent != null ) m_diaModernParent.dismiss() ;</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">			else if( m_diaCompatParent != null ) m_diaCompatParent.dismiss() ;</span>
<span class="nc" id="L468">		}</span>
	}

	/**
	 * If our parent activity is an {@link AppCompatActivity}, then we need to
	 * use the corresponding {@code AlertDialog} flavor to prompt for the
	 * permission.
	 * @param listener the click listener for the &quot;OK&quot; button
	 * @return (fluid)
	 * @see #promptForWriteSettingsPermission
	 */
	protected PermissionCheckpoint promptWithAppCompatDialog(
			WriteSettingsDialogClickListener listener )
	{
<span class="nc" id="L482">		final android.support.v7.app.AlertDialog diaAnnounce =</span>
			new android.support.v7.app.AlertDialog.Builder( m_ctx )
<span class="nc" id="L484">				.setTitle( R.string.diaAnnounce_title )</span>
<span class="nc" id="L485">				.setMessage( R.string.diaAnnounce_message )</span>
<span class="nc" id="L486">				.setCancelable( false )</span>
<span class="nc" id="L487">				.setPositiveButton( android.R.string.ok, listener )</span>
<span class="nc" id="L488">				.create()</span>
				;
<span class="nc" id="L490">		listener.setParent( diaAnnounce ) ;</span>
<span class="nc" id="L491">		diaAnnounce.show() ;</span>
<span class="nc" id="L492">		return this ;</span>
	}

	/**
	 * If our parent activity is an {@link Activity}, then we need to use the
	 * corresponding {@code AlertDialog} flavor to prompt for the permission.
	 * @param listener the click listener for the &quot;OK&quot; button
	 * @return (fluid)
	 * @see #promptForWriteSettingsPermission
	 */
	protected PermissionCheckpoint promptWithModernDialog(
			WriteSettingsDialogClickListener listener )
	{
<span class="nc" id="L505">		final android.app.AlertDialog diaAnnounce =</span>
			new android.app.AlertDialog.Builder( m_ctx )
<span class="nc" id="L507">				.setTitle( R.string.diaAnnounce_title )</span>
<span class="nc" id="L508">				.setMessage( R.string.diaAnnounce_message )</span>
<span class="nc" id="L509">				.setCancelable( false )</span>
<span class="nc" id="L510">				.setPositiveButton( android.R.string.ok, listener )</span>
<span class="nc" id="L511">				.create()</span>
				;
<span class="nc" id="L513">		listener.setParent( diaAnnounce ) ;</span>
<span class="nc" id="L514">		diaAnnounce.show() ;</span>
<span class="nc" id="L515">		return this ;</span>
	}

	/**
	 * Prompts the user to enable &quot;dangerous&quot; permissions.
	 * @param asDangers a list of dangerous permissions
	 * @return (fluid)
	 */
	protected PermissionCheckpoint promptForOtherDangers( ArrayList&lt;String&gt; asDangers )
	{
<span class="nc" id="L525">		m_bDialogVisible = true ;</span>
<span class="nc bnc" id="L526" title="All 4 branches missed.">		if( Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M &amp;&amp; ! this.isContextAppCompat() )</span>
		{
<span class="nc" id="L528">			m_actContext.requestPermissions(</span>
<span class="nc" id="L529">					asDangers.toArray( new String[asDangers.size()] ),</span>
					DANGER_REQUEST_CODE ) ;
		}
		else
		{
<span class="nc" id="L534">			ActivityCompat.requestPermissions( m_actCompatContext,</span>
<span class="nc" id="L535">					asDangers.toArray( new String[asDangers.size()] ),</span>
					DANGER_REQUEST_CODE ) ;
		}
<span class="nc" id="L538">		return this ;</span>
	}

	/**
	 * Dialogs spawned by {@link ActivityCompat#requestPermissions} will call
	 * back to this method when the user chooses any option. We will use this
	 * callback to re-check the permission array and determine whether we need
	 * to try again.
	 * @param zCode the request code (we are interested in
	 *              {@link #DANGER_REQUEST_CODE})
	 * @param asDangers an array of permissions that were requested
	 * @param azStatus an array of result indicators
	 */
	@RequiresApi( api = Build.VERSION_CODES.M )
	public void processRequestResults( int zCode,
		@NonNull String[] asDangers, @NonNull int[] azStatus )
	{
<span class="nc" id="L555">		m_bDialogVisible = false ;</span>
<span class="nc" id="L556">		Log.d( LOG_TAG, (new StringBuilder())</span>
<span class="nc" id="L557">				.append( &quot;Received new status for [&quot; )</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">				.append( asDangers.length )</span>
<span class="nc" id="L559">				.append(( asDangers.length == 1 ? &quot;] permission.&quot; : &quot;] permissions.&quot; ))</span>
<span class="nc" id="L560">				.toString()</span>
			);
<span class="nc bnc" id="L562" title="All 2 branches missed.">		for( int i = 0 ; i &lt; asDangers.length ; i++ )</span>
		{ // Update our map of permissions to grant status.
<span class="nc bnc" id="L564" title="All 2 branches missed.">			if( azStatus[i] == PackageManager.PERMISSION_GRANTED )</span>
<span class="nc" id="L565">				m_mapGranted.put( asDangers[i], true ) ;</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">			else if( azStatus[i] == PackageManager.PERMISSION_DENIED )</span>
<span class="nc" id="L567">				m_mapGranted.put( asDangers[i], false ) ;</span>
		}
<span class="nc" id="L569">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Generated by the Android Gradle plugin 3.1.3</div></body></html>